generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS - FASE 1
// ============================================================

enum Role {
  STUDENT
  COMPANY
  UNIVERSITY
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING_VERIFICATION
  SUSPENDED
}

// ============================================================
// ENUMS - FASE 2
// ============================================================

enum JobOfferStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum ApplicationStatus {
  SUBMITTED
  VIEWED
  INTERVIEW_REQUESTED
  HIRED
  REJECTED
}

// ============================================================
// ENUMS - FASE 3
// ============================================================

enum MembershipStatus {
  ACTIVE
  INACTIVE
}

enum ProgramCompanyStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProgramOfferStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum ProgramApplicationStatus {
  SUBMITTED
  REVIEWED
  ACCEPTED
  REJECTED
}

// ============================================================
// ENUMS - FASE 4
// ============================================================

enum NotificationType {
  APPLICATION_STATUS_CHANGED
  OFFER_APPROVED
  COMPANY_APPROVED
  PROGRAM_CREATED
  GENERAL
}

enum AgreementStatus {
  PENDING
  ACTIVE
  CLOSED
}

// ============================================================
// USER & PROFILES - FASE 1
// ============================================================

model User {
  id        Int        @id @default(autoincrement())
  email     String     @unique
  password  String
  role      Role
  status    UserStatus @default(PENDING_VERIFICATION)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Profiles (one-to-one based on role)
  studentProfile    StudentProfile?
  companyProfile    CompanyProfile?
  universityProfile UniversityProfile?

  // Relations
  refreshTokens RefreshToken[]
  
  // Relations - FASE 4
  notifications Notification[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model StudentProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  firstName   String
  lastName    String
  phoneNumber String?
  city        String?
  country     String?
  resumeUrl   String?
  linkedinUrl String?
  githubUrl   String?
  bio         String?  @db.Text
  skills      String?  @db.Text
  
  // FASE 3 - University affiliation
  dateOfBirth String?
  careerField String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations - FASE 2
  applications JobApplication[]
  savedOffers  SavedOffer[]
  
  // Relations - FASE 3
  universityMembership UniversityMembership?
  programApplications  ProgramApplication[]
  
  // Relations - FASE 4
  courseCompletions CourseCompletion[]

  @@index([userId])
}

model CompanyProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  companyName String
  industry    String?
  size        String?
  website     String?
  description String?  @db.Text
  logoUrl     String?
  city        String?
  country     String?
  
  // FASE 3
  foundedYear Int?
  companySize String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations - FASE 2
  jobOffers    JobOffer[]
  companyNotes CompanyNote[]
  
  // Relations - FASE 3
  programCompanies ProgramCompany[]
  programOffers    ProgramOffer[]
  
  // Relations - FASE 4
  agreements Agreement[]

  @@index([userId])
}

model UniversityProfile {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  universityName String
  city           String?
  country        String?
  website        String?
  description    String?  @db.Text
  logoUrl        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relations - FASE 3
  invites     UniversityInvite[]
  memberships UniversityMembership[]
  programs    Program[]
  
  // Relations - FASE 4
  promotions Promotion[]
  agreements Agreement[]

  @@index([userId])
}

// ============================================================
// AUTHENTICATION - FASE 1
// ============================================================

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @unique @db.VarChar(191)
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================
// JOB OFFERS & APPLICATIONS - FASE 2
// ============================================================

model JobOffer {
  id              Int             @id @default(autoincrement())
  companyId       Int
  title           String
  description     String          @db.Text
  requirements    String?         @db.Text
  location        String?
  workMode        String?         // remote, hybrid, onsite
  salary          String?
  contractType    String?         // full-time, part-time, internship, freelance
  experienceLevel String?         // junior, mid, senior
  status          JobOfferStatus  @default(DRAFT)
  publishedAt     DateTime?
  closedAt        DateTime?
  expiresAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relations
  applications JobApplication[]
  savedOffers  SavedOffer[]

  @@index([companyId])
  @@index([status])
  @@index([publishedAt])
  @@index([createdAt])
}

model SavedOffer {
  id        Int      @id @default(autoincrement())
  studentId Int
  offerId   Int
  createdAt DateTime @default(now())

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  offer   JobOffer       @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@unique([studentId, offerId])
  @@index([studentId])
  @@index([offerId])
}

model JobApplication {
  id          Int               @id @default(autoincrement())
  studentId   Int
  offerId     Int
  coverLetter String?           @db.Text
  resumeUrl   String?
  status      ApplicationStatus @default(SUBMITTED)
  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  offer   JobOffer       @relation(fields: [offerId], references: [id], onDelete: Cascade)

  // Relations
  events ApplicationEvent[]
  notes  CompanyNote[]

  @@unique([studentId, offerId])
  @@index([studentId])
  @@index([offerId])
  @@index([status])
  @@index([appliedAt])
}

model ApplicationEvent {
  id            Int      @id @default(autoincrement())
  applicationId Int
  eventType     String   // status_change, interview_scheduled, note_added, etc.
  fromStatus    String?
  toStatus      String?
  description   String?  @db.Text
  createdBy     String?  // email or role of who created the event
  createdAt     DateTime @default(now())

  application JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([createdAt])
}

model CompanyNote {
  id            Int      @id @default(autoincrement())
  companyId     Int
  applicationId Int
  note          String   @db.Text
  isPrivate     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company     CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
  application JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([applicationId])
  @@index([createdAt])
}

// ============================================================
// UNIVERSITIES & PROGRAMS - FASE 3
// ============================================================

model UniversityInvite {
  id          Int       @id @default(autoincrement())
  universityId Int
  inviteCode  String    @unique
  maxUses     Int?      // null = unlimited
  currentUses Int       @default(0)
  expiresAt   DateTime?
  createdBy   Int       // userId who created the invite
  createdAt   DateTime  @default(now())
  
  university  UniversityProfile      @relation(fields: [universityId], references: [id], onDelete: Cascade)
  memberships UniversityMembership[]
  
  @@index([universityId])
  @@index([inviteCode])
  @@index([expiresAt])
}

model UniversityMembership {
  id           Int              @id @default(autoincrement())
  universityId Int
  studentId    Int              @unique
  inviteId     Int?
  status       MembershipStatus @default(ACTIVE)
  joinedAt     DateTime         @default(now())
  
  university UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  student    StudentProfile    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  invite     UniversityInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  
  @@index([universityId])
  @@index([studentId])
  @@index([status])
}

model Program {
  id               Int       @id @default(autoincrement())
  universityId     Int
  title            String
  description      String?   @db.Text
  startDate        DateTime
  endDate          DateTime
  isActive         Boolean   @default(true)
  requiresCourseId Int?      // For future Course model integration
  maxStudents      Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  university UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  // Relations
  companies       ProgramCompany[]
  offers          ProgramOffer[]
  
  @@index([universityId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model ProgramCompany {
  id         Int                   @id @default(autoincrement())
  programId  Int
  companyId  Int
  status     ProgramCompanyStatus  @default(PENDING)
  requestedAt DateTime             @default(now())
  reviewedAt  DateTime?
  reviewedBy  Int?                 // userId who approved/rejected
  
  program Program        @relation(fields: [programId], references: [id], onDelete: Cascade)
  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([programId, companyId])
  @@index([programId])
  @@index([companyId])
  @@index([status])
}

model ProgramOffer {
  id              Int                 @id @default(autoincrement())
  programId       Int
  companyId       Int
  title           String
  description     String              @db.Text
  requirements    String?             @db.Text
  location        String?
  salary          String?
  workMode        String?             // remote, hybrid, onsite
  contractType    String?             // full-time, part-time, internship
  experienceLevel String?             // junior, mid, senior
  status          ProgramOfferStatus  @default(DRAFT)
  maxApplicants   Int?
  createdAt       DateTime            @default(now())
  approvedAt      DateTime?
  approvedBy      Int?                // userId who approved
  
  program Program        @relation(fields: [programId], references: [id], onDelete: Cascade)
  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Relations
  applications ProgramApplication[]
  
  @@index([programId])
  @@index([companyId])
  @@index([status])
}

model ProgramApplication {
  id          Int                      @id @default(autoincrement())
  offerId     Int
  studentId   Int
  coverLetter String?                  @db.Text
  resumeUrl   String?
  status      ProgramApplicationStatus @default(SUBMITTED)
  appliedAt   DateTime                 @default(now())
  reviewedAt  DateTime?
  
  offer   ProgramOffer   @relation(fields: [offerId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([offerId, studentId])
  @@index([offerId])
  @@index([studentId])
  @@index([status])
  @@index([appliedAt])
}

// ============================================================
// COURSES - FASE 4
// ============================================================

model Course {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  duration    Int?     // Duration in hours
  platform    String?
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  completions CourseCompletion[]
  
  @@index([title])
}

model CourseCompletion {
  id             Int       @id @default(autoincrement())
  courseId       Int
  studentId      Int
  completedAt    DateTime  @default(now())
  certificateUrl String?
  
  course  Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, studentId])
  @@index([courseId])
  @@index([studentId])
  @@index([completedAt])
}

// ============================================================
// PROMOTIONS - FASE 4
// ============================================================

model Promotion {
  id                 Int       @id @default(autoincrement())
  code               String    @unique
  description        String    @db.Text
  discountPercent    Int?
  discountAmount     Decimal?  @db.Decimal(10, 2)
  startDate          DateTime
  endDate            DateTime
  isActive           Boolean   @default(true)
  targetRole         Role?
  targetUniversityId Int?
  maxUses            Int?
  currentUses        Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  targetUniversity UniversityProfile? @relation(fields: [targetUniversityId], references: [id], onDelete: SetNull)
  
  @@index([code])
  @@index([isActive])
  @@index([targetRole])
  @@index([targetUniversityId])
}

// ============================================================
// NOTIFICATIONS - FASE 4
// ============================================================

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  title     String
  message   String           @db.Text
  type      NotificationType
  relatedId Int?             // ID of related entity (application, offer, etc)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================
// AGREEMENTS - FASE 4
// ============================================================

model Agreement {
  id           Int             @id @default(autoincrement())
  universityId Int
  companyId    Int
  title        String
  description  String?         @db.Text
  startDate    DateTime
  endDate      DateTime?
  status       AgreementStatus @default(PENDING)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  university UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  company    CompanyProfile    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([universityId])
  @@index([companyId])
  @@index([status])
}

